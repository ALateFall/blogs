---
layout: post
title: [安洵杯 2019]game
date: 2020-11-30
tags: ["逆向"]
---

[toc]

# 前置知识

## Ollvm反混淆

可以看[这里](https://www.freebuf.com/articles/terminal/130142.html)
使用[deflat.py](https://github.com/cq674350529/deflat)反混淆，使用方法：
`python deflat.py -f path/to/binary --addr hexaddress`
path/to/binary填文件，hexaddress填函数入口地址。

# 解题流程

才刚刚做了一道去平坦化的...
开题，发现main函数和main函数里面的几个加密函数都是被混淆的，使用deflat.py脚本对每个函数都进行反混淆。
trace函数我这里没有反混淆成功，但是问题不大，用不到。
反混淆后main函数如下：
[![](http://ltfa1l.top/wp-content/uploads/2020/11/wp_editor_md_56815cf846b1fa563e578c32c616e002.jpg)](wp_editor_md_56815cf846b1fa563e578c32c616e002.jpg)
红色框是对我们自己的输入进行的处理和加密，而蓝色框是对需要比对的字符串进行的加密，不需要管是怎么进行的，调试直接查看值即可。
跟进check1()函数：
[![](http://ltfa1l.top/wp-content/uploads/2020/11/wp_editor_md_afc595840226af2fc706a517514b82b4.jpg)](wp_editor_md_afc595840226af2fc706a517514b82b4.jpg)
分三步，一步是把输入的前半部分和后半部分交换，第二步是两位两位的交换，第三步是一个看起来比较复杂的异或操作，前两步逆向比较简单，第三步直接爆破即可。
继续，跟进check3()函数：
[![](http://ltfa1l.top/wp-content/uploads/2020/11/wp_editor_md_b95b59d27e5d5da0e12d9e24c24293a2.jpg)](wp_editor_md_b95b59d27e5d5da0e12d9e24c24293a2.jpg)
发现其实是check2()在加密，check3()就负责输入输出。
跟进：
[![](http://ltfa1l.top/wp-content/uploads/2020/11/wp_editor_md_92ce7a8b7d74a3695ab2adebbc9ded58.jpg)](wp_editor_md_92ce7a8b7d74a3695ab2adebbc9ded58.jpg)
如图所示，因此只需要比对调试的时候得到的sudoku和未开始处理的D0g3两个数组的324位（81&#42;4），假如D0g3该位为0，而sudoku不为0，那么这一位int值就是上面传下来的。
整个加密过程就分析完了。

# 解题流程

上脚本：

    sudoku = [0x01, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x05, 0x00,
              0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
              0x07, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x09, 0x00,
              0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
              0x03, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x06, 0x00,
              0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00,
              0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x07, 0x00,
              0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,
              0x02, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x01, 0x00,
              0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
              0x04, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x04, 0x00,
              0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00,
              0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x05, 0x00,
              0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,
              0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00,
              0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00,
              0x07, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x09, 0x00,
              0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00,
              0x07, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x03, 0x00,
              0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
              0x06, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x08, 0x00,
              0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
              0x06, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x05, 0x00,
              0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
              0x08, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x09, 0x00,
              0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
              0x04, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x06, 0x00,
              0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
              0x03, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x05, 0x00,
              0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
              0x09, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x08, 0x00,
              0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00,
              0x04, 0x00, 0x00, 0x00]
    _sudoku = [0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x00,
               0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
               0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
               0x00, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,
               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
               0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x04, 0x00,
               0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x09, 0x00,
               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00,
               0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00,
               0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
               0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x08, 0x00,
               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x00,
               0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x09, 0x00,
               0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
               0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
               0x04, 0x00, 0x00, 0x00]
    keynum = []
    '''
    幸福我不愿只能幻想
    醒来时惊恐的心悬停腹中寻氧
    '''

    # 比对，得到一个为0而另一个不为0的值
    for i in range(324):
        if sudoku[i] != 0 and _sudoku[i] == 0:
            keynum.append(sudoku[i])

    # 加了两次，一个是check2的48和check1的20
    for i in range(len(keynum)):
        keynum[i] = keynum[i] + 68

    # 爆破
    _flag = []
    for i in range(40):
        for j in range(32, 128):
            if (j & 0xF3 ' ~j & 0xC) == keynum[i]:
                _flag.append(chr(j))
                break

    # 交换
    for i in range(0, 40, 2):
        _flag[i], _flag[i + 1] = _flag[i + 1], _flag[i]

    # 交换
    j = 20
    for i in range(0, 20):
        _flag[i], _flag[j] = _flag[j], _flag[i]
        j += 1
    for i in _flag:
        print(i, end="")

flag{KDEEIFGKIJ@AFGEJAEF@FDKADFGIJFA@FDE@JG@J}